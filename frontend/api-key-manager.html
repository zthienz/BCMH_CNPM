<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω API Key - Du l·ªãch Tr√† Vinh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Load services -->
    <script src="components/env-loader.js"></script>
    <script src="components/gemini-config.js"></script>
    <script src="components/gemini-api-service.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">
                    <i class="fas fa-key text-blue-600 mr-3"></i>
                    Qu·∫£n l√Ω API Key Gemini
                </h1>
                <p class="text-center text-gray-600">C·∫•u h√¨nh v√† qu·∫£n l√Ω API key cho chatbot AI</p>
            </div>

            <!-- Current Status -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">
                    <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                    Tr·∫°ng th√°i hi·ªán t·∫°i
                </h2>
                
                <div id="currentStatus" class="space-y-3">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium">API Key:</span>
                        <span id="currentApiKey" class="text-gray-600">ƒêang t·∫£i...</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium">Tr·∫°ng th√°i:</span>
                        <span id="apiStatus" class="text-gray-600">ƒêang ki·ªÉm tra...</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium">L·∫ßn test cu·ªëi:</span>
                        <span id="lastTest" class="text-gray-600">Ch∆∞a test</span>
                    </div>
                </div>
            </div>

            <!-- Update API Key -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">
                    <i class="fas fa-edit text-green-600 mr-2"></i>
                    C·∫≠p nh·∫≠t API Key
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Gemini API Key m·ªõi:
                        </label>
                        <input type="password" id="newApiKey" 
                               placeholder="Nh·∫≠p API key m·ªõi (AIzaSy...)" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">API key s·∫Ω ƒë∆∞·ª£c l∆∞u trong localStorage c·ªßa tr√¨nh duy·ªát</p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="updateApiKey()" 
                                class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300">
                            <i class="fas fa-save mr-2"></i>
                            C·∫≠p nh·∫≠t API Key
                        </button>
                        <button onclick="testApiKey()" 
                                class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-300">
                            <i class="fas fa-play mr-2"></i>
                            Test
                        </button>
                    </div>
                </div>
            </div>

            <!-- Test Results -->
            <div id="testResults" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
                <h2 class="text-xl font-semibold mb-4">
                    <i class="fas fa-flask text-purple-600 mr-2"></i>
                    K·∫øt qu·∫£ Test
                </h2>
                <div id="testOutput" class="bg-gray-50 p-4 rounded-lg min-h-[100px] whitespace-pre-wrap"></div>
            </div>

            <!-- Instructions -->
            <div class="bg-blue-50 rounded-lg p-6">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">
                    <i class="fas fa-question-circle mr-2"></i>
                    H∆∞·ªõng d·∫´n l·∫•y API Key
                </h2>
                
                <div class="space-y-4 text-blue-700">
                    <div class="flex items-start">
                        <span class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 mt-0.5">1</span>
                        <div>
                            <p class="font-medium">Truy c·∫≠p Google AI Studio:</p>
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" 
                               class="text-blue-600 underline hover:text-blue-800">
                                https://aistudio.google.com/app/apikey
                            </a>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <span class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 mt-0.5">2</span>
                        <p>ƒêƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n Google c·ªßa b·∫°n</p>
                    </div>
                    
                    <div class="flex items-start">
                        <span class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 mt-0.5">3</span>
                        <p>Nh·∫•n "Create API Key" v√† ch·ªçn project</p>
                    </div>
                    
                    <div class="flex items-start">
                        <span class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 mt-0.5">4</span>
                        <p>Copy API key (ƒë·ªãnh d·∫°ng: AIzaSy...) v√† paste v√†o √¥ tr√™n</p>
                    </div>
                    
                    <div class="flex items-start">
                        <span class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 mt-0.5">5</span>
                        <p>Nh·∫•n "Test" ƒë·ªÉ ki·ªÉm tra v√† "C·∫≠p nh·∫≠t API Key" ƒë·ªÉ l∆∞u</p>
                    </div>
                </div>
            </div>

            <!-- Back to Home -->
            <div class="text-center mt-6">
                <a href="index.html" class="inline-flex items-center px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-300">
                    <i class="fas fa-home mr-2"></i>
                    V·ªÅ trang ch·ªß
                </a>
            </div>
        </div>
    </div>

    <script>
        // Load current status
        function loadCurrentStatus() {
            // API Key
            const currentKey = window.envLoader?.get('GEMINI_API_KEY') || 'Ch∆∞a c·∫•u h√¨nh';
            document.getElementById('currentApiKey').textContent = 
                currentKey === 'YOUR_ACTUAL_GEMINI_API_KEY' ? 'Ch∆∞a c·∫•u h√¨nh' : 
                currentKey.startsWith('AIzaSy') ? `${currentKey.substring(0, 10)}...` : 'Kh√¥ng h·ª£p l·ªá';
            
            // Status
            const isValid = window.geminiApiService?.isApiKeyValid() || false;
            const statusElement = document.getElementById('apiStatus');
            if (isValid) {
                statusElement.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>H·ª£p l·ªá</span>';
            } else {
                statusElement.innerHTML = '<span class="text-red-600"><i class="fas fa-times-circle mr-1"></i>Ch∆∞a h·ª£p l·ªá</span>';
            }
            
            // Last test
            const lastTest = localStorage.getItem('gemini_last_test');
            document.getElementById('lastTest').textContent = lastTest || 'Ch∆∞a test';
        }

        // Update API key
        async function updateApiKey() {
            const newKey = document.getElementById('newApiKey').value.trim();
            
            if (!newKey) {
                alert('Vui l√≤ng nh·∫≠p API key');
                return;
            }
            
            if (!newKey.startsWith('AIzaSy') || newKey.length < 35) {
                alert('API key kh√¥ng h·ª£p l·ªá. API key Gemini ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "AIzaSy" v√† d√†i √≠t nh·∫•t 35 k√Ω t·ª±.');
                return;
            }
            
            try {
                // Update in service
                const success = window.geminiApiService?.updateApiKey(newKey);
                
                if (success) {
                    alert('‚úÖ API key ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!');
                    document.getElementById('newApiKey').value = '';
                    loadCurrentStatus();
                } else {
                    alert('‚ùå Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t API key. Vui l√≤ng th·ª≠ l·∫°i.');
                }
            } catch (error) {
                console.error('Error updating API key:', error);
                alert('‚ùå L·ªói khi c·∫≠p nh·∫≠t API key: ' + error.message);
            }
        }

        // Test API key
        async function testApiKey() {
            const testResults = document.getElementById('testResults');
            const testOutput = document.getElementById('testOutput');
            
            testResults.classList.remove('hidden');
            testOutput.textContent = 'ƒêang test API key...';
            
            try {
                const success = await window.geminiApiService?.testConnection();
                
                if (success) {
                    testOutput.textContent = '‚úÖ Test th√†nh c√¥ng! API key ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.';
                    localStorage.setItem('gemini_last_test', new Date().toLocaleString('vi-VN'));
                    loadCurrentStatus();
                } else {
                    testOutput.textContent = '‚ùå Test th·∫•t b·∫°i! API key kh√¥ng ho·∫°t ƒë·ªông ho·∫∑c ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh.';
                }
            } catch (error) {
                testOutput.textContent = `‚ùå L·ªói khi test API: ${error.message}`;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß API Key Manager loaded');
            
            // Wait for services to load
            setTimeout(() => {
                loadCurrentStatus();
            }, 1000);
            
            // Add Enter key support
            document.getElementById('newApiKey').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    updateApiKey();
                }
            });
        });
    </script>
</body>
</html>
