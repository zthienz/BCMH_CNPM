<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý API Key - Du lịch Trà Vinh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Load services -->
    <script src="components/env-loader.js"></script>
    <script src="components/gemini-config.js"></script>
    <script src="components/gemini-api-service.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">
                    <i class="fas fa-key text-blue-600 mr-3"></i>
                    Quản lý API Key Gemini
                </h1>
                <p class="text-center text-gray-600">Cấu hình và quản lý API key cho chatbot AI</p>
            </div>

            <!-- Current Status -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">
                    <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                    Trạng thái hiện tại
                </h2>
                
                <div id="currentStatus" class="space-y-3">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium">API Key:</span>
                        <span id="currentApiKey" class="text-gray-600">Đang tải...</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium">Trạng thái:</span>
                        <span id="apiStatus" class="text-gray-600">Đang kiểm tra...</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium">Lần test cuối:</span>
                        <span id="lastTest" class="text-gray-600">Chưa test</span>
                    </div>
                </div>
            </div>

            <!-- Update API Key -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">
                    <i class="fas fa-edit text-green-600 mr-2"></i>
                    Cập nhật API Key
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Gemini API Key mới:
                        </label>
                        <input type="password" id="newApiKey" 
                               placeholder="Nhập API key mới (AIzaSy...)" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">API key sẽ được lưu trong localStorage của trình duyệt</p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="updateApiKey()" 
                                class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300">
                            <i class="fas fa-save mr-2"></i>
                            Cập nhật API Key
                        </button>
                        <button onclick="testApiKey()" 
                                class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-300">
                            <i class="fas fa-play mr-2"></i>
                            Test
                        </button>
                    </div>
                </div>
            </div>

            <!-- Test Results -->
            <div id="testResults" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
                <h2 class="text-xl font-semibold mb-4">
                    <i class="fas fa-flask text-purple-600 mr-2"></i>
                    Kết quả Test
                </h2>
                <div id="testOutput" class="bg-gray-50 p-4 rounded-lg min-h-[100px] whitespace-pre-wrap"></div>
            </div>

            <!-- Instructions -->
            <div class="bg-blue-50 rounded-lg p-6">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">
                    <i class="fas fa-question-circle mr-2"></i>
                    Hướng dẫn lấy API Key
                </h2>
                
                <div class="space-y-4 text-blue-700">
                    <div class="flex items-start">
                        <span class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 mt-0.5">1</span>
                        <div>
                            <p class="font-medium">Truy cập Google AI Studio:</p>
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" 
                               class="text-blue-600 underline hover:text-blue-800">
                                https://aistudio.google.com/app/apikey
                            </a>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <span class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 mt-0.5">2</span>
                        <p>Đăng nhập bằng tài khoản Google của bạn</p>
                    </div>
                    
                    <div class="flex items-start">
                        <span class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 mt-0.5">3</span>
                        <p>Nhấn "Create API Key" và chọn project</p>
                    </div>
                    
                    <div class="flex items-start">
                        <span class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 mt-0.5">4</span>
                        <p>Copy API key (định dạng: AIzaSy...) và paste vào ô trên</p>
                    </div>
                    
                    <div class="flex items-start">
                        <span class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 mt-0.5">5</span>
                        <p>Nhấn "Test" để kiểm tra và "Cập nhật API Key" để lưu</p>
                    </div>
                </div>
            </div>

            <!-- Back to Home -->
            <div class="text-center mt-6">
                <a href="index.html" class="inline-flex items-center px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-300">
                    <i class="fas fa-home mr-2"></i>
                    Về trang chủ
                </a>
            </div>
        </div>
    </div>

    <script>
        // Load current status
        function loadCurrentStatus() {
            // API Key
            const currentKey = window.envLoader?.get('GEMINI_API_KEY') || 'Chưa cấu hình';
            document.getElementById('currentApiKey').textContent = 
                currentKey === 'YOUR_ACTUAL_GEMINI_API_KEY' ? 'Chưa cấu hình' : 
                currentKey.startsWith('AIzaSy') ? `${currentKey.substring(0, 10)}...` : 'Không hợp lệ';
            
            // Status
            const isValid = window.geminiApiService?.isApiKeyValid() || false;
            const statusElement = document.getElementById('apiStatus');
            if (isValid) {
                statusElement.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Hợp lệ</span>';
            } else {
                statusElement.innerHTML = '<span class="text-red-600"><i class="fas fa-times-circle mr-1"></i>Chưa hợp lệ</span>';
            }
            
            // Last test
            const lastTest = localStorage.getItem('gemini_last_test');
            document.getElementById('lastTest').textContent = lastTest || 'Chưa test';
        }

        // Update API key
        async function updateApiKey() {
            const newKey = document.getElementById('newApiKey').value.trim();
            
            if (!newKey) {
                alert('Vui lòng nhập API key');
                return;
            }
            
            if (!newKey.startsWith('AIzaSy') || newKey.length < 35) {
                alert('API key không hợp lệ. API key Gemini phải bắt đầu bằng "AIzaSy" và dài ít nhất 35 ký tự.');
                return;
            }
            
            try {
                // Update in service
                const success = window.geminiApiService?.updateApiKey(newKey);
                
                if (success) {
                    alert('✅ API key đã được cập nhật thành công!');
                    document.getElementById('newApiKey').value = '';
                    loadCurrentStatus();
                } else {
                    alert('❌ Không thể cập nhật API key. Vui lòng thử lại.');
                }
            } catch (error) {
                console.error('Error updating API key:', error);
                alert('❌ Lỗi khi cập nhật API key: ' + error.message);
            }
        }

        // Test API key
        async function testApiKey() {
            const testResults = document.getElementById('testResults');
            const testOutput = document.getElementById('testOutput');
            
            testResults.classList.remove('hidden');
            testOutput.textContent = 'Đang test API key...';
            
            try {
                const success = await window.geminiApiService?.testConnection();
                
                if (success) {
                    testOutput.textContent = '✅ Test thành công! API key hoạt động bình thường.';
                    localStorage.setItem('gemini_last_test', new Date().toLocaleString('vi-VN'));
                    loadCurrentStatus();
                } else {
                    testOutput.textContent = '❌ Test thất bại! API key không hoạt động hoặc chưa được cấu hình.';
                }
            } catch (error) {
                testOutput.textContent = `❌ Lỗi khi test API: ${error.message}`;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 API Key Manager loaded');
            
            // Wait for services to load
            setTimeout(() => {
                loadCurrentStatus();
            }, 1000);
            
            // Add Enter key support
            document.getElementById('newApiKey').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    updateApiKey();
                }
            });
        });
    </script>
</body>
</html>
