<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Performance Test - Du lịch Trà Vinh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-tachometer-alt text-blue-600 mr-3"></i>
                    Chatbot Performance Test
                </h1>
                <p class="text-xl text-gray-600">Kiểm tra tốc độ và hiệu suất chatbot</p>
            </div>

            <!-- Performance Stats -->
            <div class="grid md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center">
                        <i class="fas fa-bolt text-yellow-600 text-3xl mr-4"></i>
                        <div>
                            <p class="text-gray-600 text-sm">Avg Response Time</p>
                            <p id="avgResponseTime" class="text-2xl font-bold text-gray-800">--</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center">
                        <i class="fas fa-database text-blue-600 text-3xl mr-4"></i>
                        <div>
                            <p class="text-gray-600 text-sm">Cache Hit Rate</p>
                            <p id="cacheHitRate" class="text-2xl font-bold text-gray-800">--</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center">
                        <i class="fas fa-comments text-green-600 text-3xl mr-4"></i>
                        <div>
                            <p class="text-gray-600 text-sm">Total Messages</p>
                            <p id="totalMessages" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-purple-600 text-3xl mr-4"></i>
                        <div>
                            <p class="text-gray-600 text-sm">Success Rate</p>
                            <p id="successRate" class="text-2xl font-bold text-gray-800">--</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Controls -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-semibold mb-6">
                    <i class="fas fa-play-circle text-green-600 mr-2"></i>
                    Performance Tests
                </h2>
                
                <div class="grid md:grid-cols-3 gap-6">
                    <!-- Cache Test -->
                    <div class="text-center">
                        <div class="bg-gradient-to-r from-blue-500 to-cyan-600 text-white p-6 rounded-xl mb-4">
                            <i class="fas fa-rocket text-4xl mb-3"></i>
                            <h3 class="text-xl font-semibold">Cache Speed Test</h3>
                            <p class="text-sm opacity-90 mt-2">Test cached responses</p>
                        </div>
                        <button onclick="testCacheSpeed()" 
                                class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300">
                            <i class="fas fa-play mr-2"></i>
                            Test Cache
                        </button>
                    </div>

                    <!-- API Test -->
                    <div class="text-center">
                        <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-6 rounded-xl mb-4">
                            <i class="fas fa-cloud text-4xl mb-3"></i>
                            <h3 class="text-xl font-semibold">API Speed Test</h3>
                            <p class="text-sm opacity-90 mt-2">Test API response time</p>
                        </div>
                        <button onclick="testAPISpeed()" 
                                class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-300">
                            <i class="fas fa-play mr-2"></i>
                            Test API
                        </button>
                    </div>

                    <!-- Stress Test -->
                    <div class="text-center">
                        <div class="bg-gradient-to-r from-red-500 to-pink-600 text-white p-6 rounded-xl mb-4">
                            <i class="fas fa-fire text-4xl mb-3"></i>
                            <h3 class="text-xl font-semibold">Stress Test</h3>
                            <p class="text-sm opacity-90 mt-2">Multiple concurrent requests</p>
                        </div>
                        <button onclick="stressTest()" 
                                class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition duration-300">
                            <i class="fas fa-play mr-2"></i>
                            Stress Test
                        </button>
                    </div>
                </div>
            </div>

            <!-- Test Results -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-semibold mb-6">
                    <i class="fas fa-chart-line text-purple-600 mr-2"></i>
                    Test Results
                </h2>
                
                <div id="testResults" class="space-y-4">
                    <p class="text-gray-600">Chưa có kết quả test. Hãy chạy một test để xem kết quả.</p>
                </div>
            </div>

            <!-- Cache Stats -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-semibold mb-6">
                    <i class="fas fa-database text-blue-600 mr-2"></i>
                    Cache Statistics
                </h2>
                
                <div id="cacheStats" class="grid md:grid-cols-4 gap-4">
                    <!-- Will be populated by JavaScript -->
                </div>
                
                <div class="mt-6 text-center">
                    <button onclick="clearCache()" 
                            class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition duration-300">
                        <i class="fas fa-trash mr-2"></i>
                        Clear Cache
                    </button>
                </div>
            </div>

            <!-- Quick Test Messages -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-6">
                    <i class="fas fa-comments text-green-600 mr-2"></i>
                    Quick Test Messages
                </h2>
                
                <div class="grid md:grid-cols-3 gap-4">
                    <button onclick="quickTest('địa điểm nổi tiếng')" 
                            class="p-4 bg-blue-50 hover:bg-blue-100 rounded-lg text-left transition duration-300">
                        <i class="fas fa-map-marker-alt text-blue-600 mr-2"></i>
                        <span class="font-medium">Địa điểm nổi tiếng</span>
                    </button>
                    
                    <button onclick="quickTest('ẩm thực đặc sản')" 
                            class="p-4 bg-green-50 hover:bg-green-100 rounded-lg text-left transition duration-300">
                        <i class="fas fa-utensils text-green-600 mr-2"></i>
                        <span class="font-medium">Ẩm thực đặc sản</span>
                    </button>
                    
                    <button onclick="quickTest('chi phí')" 
                            class="p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg text-left transition duration-300">
                        <i class="fas fa-dollar-sign text-yellow-600 mr-2"></i>
                        <span class="font-medium">Chi phí du lịch</span>
                    </button>
                    
                    <button onclick="quickTest('cách đi')" 
                            class="p-4 bg-purple-50 hover:bg-purple-100 rounded-lg text-left transition duration-300">
                        <i class="fas fa-route text-purple-600 mr-2"></i>
                        <span class="font-medium">Cách di chuyển</span>
                    </button>
                    
                    <button onclick="quickTest('lịch trình 1 ngày')" 
                            class="p-4 bg-red-50 hover:bg-red-100 rounded-lg text-left transition duration-300">
                        <i class="fas fa-calendar text-red-600 mr-2"></i>
                        <span class="font-medium">Lịch trình 1 ngày</span>
                    </button>
                    
                    <button onclick="quickTest('thời gian tốt nhất')" 
                            class="p-4 bg-indigo-50 hover:bg-indigo-100 rounded-lg text-left transition duration-300">
                        <i class="fas fa-clock text-indigo-600 mr-2"></i>
                        <span class="font-medium">Thời gian tốt nhất</span>
                    </button>
                </div>
            </div>

            <!-- Back to Chatbot -->
            <div class="text-center mt-8">
                <a href="gemini-chatbot.html" class="inline-flex items-center px-8 py-4 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition duration-300 text-lg mr-4">
                    <i class="fas fa-robot mr-3"></i>
                    Mở Chatbot
                </a>
                <a href="index.html" class="inline-flex items-center px-8 py-4 bg-gray-600 text-white rounded-xl hover:bg-gray-700 transition duration-300 text-lg">
                    <i class="fas fa-home mr-3"></i>
                    Về Trang Chủ
                </a>
            </div>
        </div>
    </div>

    <!-- Load Dependencies -->
    <script src="components/response-cache.js"></script>
    <script src="components/gemini-config.js"></script>
    <script src="components/gemini-api-service.js"></script>

    <script>
        let testStats = {
            totalTests: 0,
            successfulTests: 0,
            totalResponseTime: 0,
            cacheHits: 0
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            updateCacheStats();
            
            // Update stats every 5 seconds
            setInterval(updateStats, 5000);
        });

        // Test cache speed
        async function testCacheSpeed() {
            const testMessages = ['địa điểm nổi tiếng', 'ẩm thực đặc sản', 'chi phí', 'cách đi'];
            const results = [];
            
            addTestResult('🚀 Starting Cache Speed Test...', 'info');
            
            for (const message of testMessages) {
                const startTime = performance.now();
                
                if (window.responseCache && window.responseCache.has(message)) {
                    const response = window.responseCache.get(message);
                    const endTime = performance.now();
                    const responseTime = endTime - startTime;
                    
                    results.push({
                        message: message,
                        responseTime: responseTime,
                        cached: true,
                        success: true
                    });
                    
                    testStats.cacheHits++;
                } else {
                    results.push({
                        message: message,
                        responseTime: 0,
                        cached: false,
                        success: false
                    });
                }
                
                testStats.totalTests++;
                if (results[results.length - 1].success) {
                    testStats.successfulTests++;
                    testStats.totalResponseTime += results[results.length - 1].responseTime;
                }
            }
            
            // Display results
            const avgTime = results.reduce((sum, r) => sum + r.responseTime, 0) / results.length;
            addTestResult(`✅ Cache Test Complete - Avg: ${avgTime.toFixed(2)}ms`, 'success');
            
            results.forEach(result => {
                const status = result.cached ? '⚡ Cached' : '❌ Not cached';
                addTestResult(`${status}: "${result.message}" - ${result.responseTime.toFixed(2)}ms`, 
                             result.cached ? 'success' : 'warning');
            });
            
            updateStats();
        }

        // Test API speed
        async function testAPISpeed() {
            addTestResult('🌐 Starting API Speed Test...', 'info');
            
            const testMessage = 'Test API response time';
            const startTime = performance.now();
            
            try {
                if (window.geminiApiService) {
                    const response = await window.geminiApiService.generateContent(testMessage);
                    const endTime = performance.now();
                    const responseTime = endTime - startTime;
                    
                    testStats.totalTests++;
                    testStats.successfulTests++;
                    testStats.totalResponseTime += responseTime;
                    
                    addTestResult(`✅ API Test Complete - ${responseTime.toFixed(2)}ms`, 'success');
                    addTestResult(`Response: ${response.substring(0, 100)}...`, 'info');
                } else {
                    addTestResult('❌ API Service not available', 'error');
                }
            } catch (error) {
                testStats.totalTests++;
                addTestResult(`❌ API Test Failed: ${error.message}`, 'error');
            }
            
            updateStats();
        }

        // Stress test
        async function stressTest() {
            addTestResult('🔥 Starting Stress Test (10 concurrent requests)...', 'info');
            
            const testMessages = [
                'địa điểm nổi tiếng', 'ẩm thực đặc sản', 'chi phí', 'cách đi', 'lịch trình 1 ngày',
                'thời gian tốt nhất', 'xin chào', 'hello', 'lịch trình 2 ngày', 'khách sạn'
            ];
            
            const startTime = performance.now();
            const promises = testMessages.map(async (message, index) => {
                const msgStartTime = performance.now();
                
                try {
                    let response;
                    if (window.responseCache && window.responseCache.has(message)) {
                        response = window.responseCache.get(message);
                        testStats.cacheHits++;
                    } else if (window.geminiApiService) {
                        response = await window.geminiApiService.generateContent(message);
                    }
                    
                    const msgEndTime = performance.now();
                    return {
                        index: index,
                        message: message,
                        responseTime: msgEndTime - msgStartTime,
                        success: true
                    };
                } catch (error) {
                    const msgEndTime = performance.now();
                    return {
                        index: index,
                        message: message,
                        responseTime: msgEndTime - msgStartTime,
                        success: false,
                        error: error.message
                    };
                }
            });
            
            try {
                const results = await Promise.all(promises);
                const endTime = performance.now();
                const totalTime = endTime - startTime;
                
                const successful = results.filter(r => r.success).length;
                const avgResponseTime = results.reduce((sum, r) => sum + r.responseTime, 0) / results.length;
                
                testStats.totalTests += results.length;
                testStats.successfulTests += successful;
                testStats.totalResponseTime += results.reduce((sum, r) => sum + r.responseTime, 0);
                
                addTestResult(`✅ Stress Test Complete - Total: ${totalTime.toFixed(2)}ms, Avg: ${avgResponseTime.toFixed(2)}ms`, 'success');
                addTestResult(`Success Rate: ${successful}/${results.length} (${(successful/results.length*100).toFixed(1)}%)`, 'info');
                
            } catch (error) {
                addTestResult(`❌ Stress Test Failed: ${error.message}`, 'error');
            }
            
            updateStats();
        }

        // Quick test single message
        async function quickTest(message) {
            addTestResult(`🧪 Testing: "${message}"`, 'info');
            
            const startTime = performance.now();
            
            try {
                let response;
                let cached = false;
                
                if (window.responseCache && window.responseCache.has(message)) {
                    response = window.responseCache.get(message);
                    cached = true;
                    testStats.cacheHits++;
                } else if (window.geminiApiService) {
                    response = await window.geminiApiService.generateContent(message);
                }
                
                const endTime = performance.now();
                const responseTime = endTime - startTime;
                
                testStats.totalTests++;
                testStats.successfulTests++;
                testStats.totalResponseTime += responseTime;
                
                const cacheStatus = cached ? '⚡ Cached' : '🌐 API';
                addTestResult(`${cacheStatus} - ${responseTime.toFixed(2)}ms`, 'success');
                addTestResult(`Response: ${response.substring(0, 150)}...`, 'info');
                
            } catch (error) {
                testStats.totalTests++;
                addTestResult(`❌ Failed: ${error.message}`, 'error');
            }
            
            updateStats();
        }

        // Add test result to display
        function addTestResult(message, type) {
            const resultsContainer = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            
            let bgColor = 'bg-gray-50';
            let textColor = 'text-gray-700';
            
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-50';
                    textColor = 'text-green-700';
                    break;
                case 'error':
                    bgColor = 'bg-red-50';
                    textColor = 'text-red-700';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-50';
                    textColor = 'text-yellow-700';
                    break;
                case 'info':
                    bgColor = 'bg-blue-50';
                    textColor = 'text-blue-700';
                    break;
            }
            
            resultDiv.className = `p-3 ${bgColor} ${textColor} rounded-lg text-sm`;
            resultDiv.innerHTML = `<span class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</span> ${message}`;
            
            resultsContainer.insertBefore(resultDiv, resultsContainer.firstChild);
            
            // Keep only last 20 results
            while (resultsContainer.children.length > 20) {
                resultsContainer.removeChild(resultsContainer.lastChild);
            }
        }

        // Update statistics
        function updateStats() {
            const avgTime = testStats.totalTests > 0 ? 
                (testStats.totalResponseTime / testStats.successfulTests).toFixed(2) : '--';
            const successRate = testStats.totalTests > 0 ? 
                ((testStats.successfulTests / testStats.totalTests) * 100).toFixed(1) + '%' : '--';
            const cacheHitRate = testStats.totalTests > 0 ? 
                ((testStats.cacheHits / testStats.totalTests) * 100).toFixed(1) + '%' : '--';
            
            document.getElementById('avgResponseTime').textContent = avgTime + 'ms';
            document.getElementById('successRate').textContent = successRate;
            document.getElementById('cacheHitRate').textContent = cacheHitRate;
            document.getElementById('totalMessages').textContent = testStats.totalTests;
        }

        // Update cache statistics
        function updateCacheStats() {
            const cacheStatsContainer = document.getElementById('cacheStats');
            
            if (window.responseCache) {
                const stats = window.responseCache.getStats();
                
                cacheStatsContainer.innerHTML = `
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-blue-600 text-sm">Total Entries</p>
                        <p class="text-2xl font-bold text-blue-800">${stats.total}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-green-600 text-sm">Valid Entries</p>
                        <p class="text-2xl font-bold text-green-800">${stats.valid}</p>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <p class="text-yellow-600 text-sm">Common Responses</p>
                        <p class="text-2xl font-bold text-yellow-800">${stats.common}</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <p class="text-red-600 text-sm">Expired</p>
                        <p class="text-2xl font-bold text-red-800">${stats.expired}</p>
                    </div>
                `;
            } else {
                cacheStatsContainer.innerHTML = '<p class="text-gray-600">Cache not available</p>';
            }
        }

        // Clear cache
        function clearCache() {
            if (window.responseCache) {
                window.responseCache.clear();
                updateCacheStats();
                addTestResult('🗑️ Cache cleared and reinitialized', 'info');
            }
        }
    </script>
</body>
</html>
